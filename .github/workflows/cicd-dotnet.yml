name: CI – Build & Test .NET App (with CD via SP)

on:
  push:
    branches: [ main ]
    paths: [ 'src/**', '.github/workflows/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'src/**', '.github/workflows/**' ]
  workflow_dispatch: {}

permissions:
  contents: read

env:
  DOTNET_VERSION: 8.0.x
  API_PROJECT: src/Summarizer.Api/Summarizer.Api.csproj

jobs:
  dotnet-build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Scan for Secrets
        uses: trufflesecurity/trufflehog@main

      - name: 🧰 Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 🛠 Restore and build .NET
        run: |
          dotnet restore ./src/AiSummarizer.sln
          dotnet build ./src/AiSummarizer.sln --no-restore --configuration Release

      - name: ✅ Run Tests (unit tests under src)
        run: dotnet test ./src/Summarizer.Tests/Summarizer.Tests.csproj --configuration Release --no-build

      - name: 📊 Collect Code Coverage
        run: dotnet test ./src/Summarizer.Tests/Summarizer.Tests.csproj --collect:"XPlat Code Coverage"

      - name: 📦 Publish API
        run: dotnet publish ${{ env.API_PROJECT }} -c Release -o ./publish

      - name: ⬆️ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapi-drop
          path: ./publish

  deploy-dev:
    needs: dotnet-build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: dev
    concurrency:
      group: appservice-dev
      cancel-in-progress: false
    steps:
      - name: 📥 Download artifact
        uses: actions/download-artifact@v4
        with:
          name: webapi-drop
          path: ./publish

      - name: 🔐 Azure login (service principal)
        uses: azure/login@v2
        with:
          creds: >
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}"
            }

      - name: 🚀 Deploy to App Service (dev)
        uses: azure/webapps-deploy@v3
        with:
          app-name: summarizer-api-dev
          package: ./publish
